<!DOCTYPE html>
<html>
<head>
  <title>Mapa Interactivo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* Estilo para el mapa */
    body, html, #map {
      height: 100%;
      margin: 0;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database.js"></script>

  <script>
    // Inicializa Firebase sin apiKey
    var firebaseConfig = {
      databaseURL: "https://eklipse42-8cd27.firebaseio.com"
    };
    firebase.initializeApp(firebaseConfig);

    var map = L.map('map').setView([41.944544, -2.314262], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var locationsRef = firebase.database().ref('locations');

    function initMap() {
      navigator.geolocation.watchPosition(function(position) {
        var lat = position.coords.latitude;
        var lon = position.coords.longitude;

        var userLocation = {
          lat: lat,
          lon: lon
        };

        // Enviar ubicación al servidor
        locationsRef.child('user1').set(userLocation);

        // Escuchar cambios en las ubicaciones y actualizar en tiempo real
        locationsRef.on('value', function(snapshot) {
          map.eachLayer(function(layer) {
            if (layer instanceof L.Marker) {
              map.removeLayer(layer);
            }
          });

          snapshot.forEach(function(childSnapshot) {
            var childKey = childSnapshot.key;
            var childData = childSnapshot.val();

            var userMarker = L.marker([childData.lat, childData.lon]).addTo(map);
            userMarker.setIcon(L.icon({
              iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet.awesome-markers/2.0.2/img/marker-icon-2x.png',
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [0, -22]
            }));

            userMarker.bindPopup("Ubicación de otro dispositivo").openPopup();
          });
        });

      }, function(error) {
        alert("Error al obtener la ubicación: " + error.message);
      });
    }

    // Llama a la función initMap después de cargar el DOM
    document.addEventListener('DOMContentLoaded', initMap);

  </script>
</body>
</html>
